<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executiva Cloud - MVP (Tailwind CSS)</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide icons for a clean UI -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Using a common font for better aesthetics */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Style for modal and sidebar transitions */
        .modal-backdrop, .sidebar-overlay {
            transition: opacity 0.3s ease;
        }
        .sidebar {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="relative min-h-screen md:flex">
        
        <!-- Sidebar Overlay (for mobile) -->
        <div id="sidebar-overlay" class="sidebar-overlay fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="sidebar bg-white border-r border-gray-200 p-4 md:p-6 flex flex-col fixed top-0 left-0 h-full w-64 md:w-64 md:static md:translate-x-0 transform -translate-x-full z-40">
            <div class="flex items-center gap-3 mb-8">
                <div class="p-2 bg-blue-600 text-white rounded-lg">
                    <i data-lucide="cloud"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800">Executiva<span class="text-blue-600">Cloud</span></h1>
            </div>

            <div class="mb-6">
                <label for="client-select" class="block text-sm font-medium text-gray-600 mb-2">Gerenciando Cliente:</label>
                <select id="client-select" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 transition">
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            
            <button id="add-client-btn" class="w-full flex items-center justify-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition shadow-sm mb-6">
                <i data-lucide="user-plus" class="w-4 h-4"></i>
                Novo Cliente
            </button>

            <nav id="main-nav" class="flex-grow">
                <!-- Navigation links will be populated by JS -->
            </nav>
            <div class="text-xs text-center text-gray-400 mt-4">
                MVP v1.5 - Viagens e Despesas
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 pb-20 md:pb-0">
            <!-- Mobile Header -->
            <header class="md:hidden sticky top-0 bg-white/80 backdrop-blur-sm border-b border-gray-200 p-4 flex items-center justify-between z-20">
                <button id="hamburger-btn" class="p-2">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h2 id="mobile-header-title" class="text-lg font-bold">Dashboard</h2>
                <div id="mobile-action-button"></div>
            </header>
            <div id="main-content" class="p-4 md:p-8">
                <!-- Content will be rendered by JS -->
            </div>
        </main>
    </div>

    <!-- Mobile Bottom Navigation -->
    <nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 grid grid-cols-5 gap-1 p-1 z-20">
        <!-- Mobile nav items will be populated by JS -->
    </nav>

    <!-- Modals -->
    <div id="add-client-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md m-4">
            <h3 class="text-xl font-bold mb-4">Adicionar Novo Cliente</h3>
            <form id="add-client-form">
                <div class="mb-4">
                    <label for="new-client-name" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cliente</label>
                    <input type="text" id="new-client-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50" data-close-modal>Cancelar</button>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Salvar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-event-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md m-4">
            <h3 class="text-xl font-bold mb-4">Adicionar Novo Evento</h3>
            <form id="add-event-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium">Título</label>
                    <input type="text" id="new-event-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium">Data</label>
                        <input type="date" id="new-event-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Hora</label>
                        <input type="time" id="new-event-time" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Descrição</label>
                    <textarea id="new-event-description" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="py-2 px-4 border border-gray-300 rounded-md text-sm font-medium" data-close-modal>Cancelar</button>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Salvar Evento</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-task-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md m-4">
            <h3 class="text-xl font-bold mb-4">Adicionar Tarefa ou Lembrete</h3>
            <form id="add-task-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium">Título</label>
                    <input type="text" id="new-task-title" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Data</label>
                    <input type="date" id="new-task-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                 <div class="mb-4">
                    <label class="block text-sm font-medium">Associar ao Cliente</label>
                    <select id="new-task-client" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        <!-- Client options will be populated by JS -->
                    </select>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="py-2 px-4 border border-gray-300 rounded-md text-sm font-medium" data-close-modal>Cancelar</button>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Salvar Tarefa</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-contact-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-lg m-4">
            <h3 class="text-xl font-bold mb-4">Adicionar Novo Contato</h3>
            <form id="add-contact-form">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium">Nome</label>
                        <input type="text" id="new-contact-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Empresa</label>
                        <input type="text" id="new-contact-company" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">E-mail</label>
                        <input type="email" id="new-contact-email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Telefone</label>
                        <input type="tel" id="new-contact-phone" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="col-span-1 sm:col-span-2">
                        <label class="block text-sm font-medium">Aniversário</label>
                        <input type="date" id="new-contact-birthday" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Notas</label>
                    <textarea id="new-contact-notes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="py-2 px-4 border border-gray-300 rounded-md text-sm font-medium" data-close-modal>Cancelar</button>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Salvar Contato</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-travel-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md m-4">
            <h3 class="text-xl font-bold mb-4">Adicionar Nova Viagem</h3>
            <form id="add-travel-form">
                <div class="mb-4">
                    <label class="block text-sm font-medium">Destino</label>
                    <input type="text" id="new-travel-destination" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium">Data de Início</label>
                        <input type="date" id="new-travel-start" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Data de Fim</label>
                        <input type="date" id="new-travel-end" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Anotações (voos, hotéis, etc.)</label>
                    <textarea id="new-travel-notes" rows="4" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="py-2 px-4 border border-gray-300 rounded-md text-sm font-medium" data-close-modal>Cancelar</button>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Salvar Viagem</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-expense-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 hidden">
        <div class="modal-content bg-white p-8 rounded-lg shadow-xl w-full max-w-md m-4">
            <h3 class="text-xl font-bold mb-4">Adicionar Nova Despesa</h3>
            <form id="add-expense-form">
                 <div class="mb-4">
                    <label class="block text-sm font-medium">Data</label>
                    <input type="date" id="new-expense-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">Descrição</label>
                    <input type="text" id="new-expense-description" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium">Valor (R$)</label>
                        <input type="number" step="0.01" id="new-expense-amount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Status</label>
                         <select id="new-expense-status" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                            <option>Lançada</option>
                            <option>Aprovada</option>
                            <option>Reembolsada</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" class="py-2 px-4 border border-gray-300 rounded-md text-sm font-medium" data-close-modal>Cancelar</button>
                    <button type="submit" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">Salvar Despesa</button>
                </div>
            </form>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- STATE MANAGEMENT ---
        let clients = [];
        let contacts = [];
        let events = [];
        let tasks = [];
        let travels = [];
        let expenses = [];
        let selectedClientId = null;
        let activeModule = 'dashboard';

        // --- DOM ELEMENT REFERENCES ---
        const mainContent = document.getElementById('main-content');
        const clientSelect = document.getElementById('client-select');
        const mainNav = document.getElementById('main-nav');
        const mobileNav = document.getElementById('mobile-nav');
        const mobileHeaderTitle = document.getElementById('mobile-header-title');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        
        // Modals
        const addClientModal = document.getElementById('add-client-modal');
        const addEventModal = document.getElementById('add-event-modal');
        const addContactModal = document.getElementById('add-contact-modal');
        const addTaskModal = document.getElementById('add-task-modal');
        const addTravelModal = document.getElementById('add-travel-modal');
        const addExpenseModal = document.getElementById('add-expense-modal');
        
        // Forms
        const addClientForm = document.getElementById('add-client-form');
        const addEventForm = document.getElementById('add-event-form');
        const addContactForm = document.getElementById('add-contact-form');
        const addTaskForm = document.getElementById('add-task-form');
        const addTravelForm = document.getElementById('add-travel-form');
        const addExpenseForm = document.getElementById('add-expense-form');

        // --- DATA PERSISTENCE ---
        const saveState = () => {
            localStorage.setItem('executiva_clients_v4', JSON.stringify(clients));
            localStorage.setItem('executiva_contacts_v4', JSON.stringify(contacts));
            localStorage.setItem('executiva_events_v4', JSON.stringify(events));
            localStorage.setItem('executiva_tasks_v4', JSON.stringify(tasks));
            localStorage.setItem('executiva_travels_v4', JSON.stringify(travels));
            localStorage.setItem('executiva_expenses_v4', JSON.stringify(expenses));
            localStorage.setItem('executiva_selectedClientId_v4', JSON.stringify(selectedClientId));
        };

        const loadState = () => {
            const storedClients = localStorage.getItem('executiva_clients_v4');
            if (storedClients && JSON.parse(storedClients).length > 0) {
                clients = JSON.parse(storedClients);
                contacts = JSON.parse(localStorage.getItem('executiva_contacts_v4')) || [];
                events = JSON.parse(localStorage.getItem('executiva_events_v4')) || [];
                tasks = JSON.parse(localStorage.getItem('executiva_tasks_v4')) || [];
                travels = JSON.parse(localStorage.getItem('executiva_travels_v4')) || [];
                expenses = JSON.parse(localStorage.getItem('executiva_expenses_v4')) || [];
                selectedClientId = JSON.parse(localStorage.getItem('executiva_selectedClientId_v4')) || null;
            } else {
                // Load mock data for first-time use
                const today = new Date();
                const nextWeek = new Date(today); nextWeek.setDate(nextWeek.getDate() + 7);
                const in15Days = new Date(today); in15Days.setDate(in15Days.getDate() + 15);
                const nextMonth = new Date(today); nextMonth.setMonth(nextMonth.getMonth() + 1);
                
                clients = [{ id: 1, name: 'Carlos Ferreira' }, { id: 2, name: 'Beatriz Almeida' }];
                events = [ { id: 101, clientId: 1, title: 'Reunião de Diretoria', date: today.toISOString().split('T')[0], time: '10:00', description: 'Apresentar resultados trimestrais.' } ];
                tasks = [ { id: 302, clientId: 2, title: 'Confirmar reserva de hotel', date: today.toISOString().split('T')[0] } ];
                travels = [ { id: 401, clientId: 1, destination: 'Nova York, EUA', start: in15Days.toISOString().split('T')[0], end: nextMonth.toISOString().split('T')[0], notes: 'Voo AA950, Hotel Marriott Marquis' } ];
                expenses = [
                    { id: 501, clientId: 1, date: today.toISOString().split('T')[0], description: 'Almoço com cliente', amount: 150.75, status: 'Lançada' },
                    { id: 502, clientId: 2, date: today.toISOString().split('T')[0], description: 'Táxi Aeroporto', amount: 85.00, status: 'Aprovada' },
                ];
                contacts = [ { id: 203, clientId: 1, name: 'Sofia Lima (Esposa)', company: 'Particular', email: 'sofia.lima@email.com', phone: '(11) 99999-8888', birthday: nextWeek.toISOString().split('T')[0], notes: 'Lembrar de comprar flores.' } ];
                selectedClientId = null;
            }
            activeModule = selectedClientId ? 'agenda' : 'dashboard';
        };

        // --- RENDER FUNCTIONS ---
        const render = () => {
            updateClientDropdown();
            updateNav();
            
            mainContent.innerHTML = ''; // Clear content before rendering
            let currentTitle = 'Dashboard';

            switch(activeModule) {
                case 'dashboard': mainContent.innerHTML = renderDashboard(); break;
                case 'agenda': mainContent.innerHTML = renderAgenda(); currentTitle = 'Agenda'; break;
                case 'tasks': mainContent.innerHTML = renderTasks(); currentTitle = 'Tarefas'; break;
                case 'travels': mainContent.innerHTML = renderTravels(); currentTitle = 'Viagens'; break;
                case 'expenses': mainContent.innerHTML = renderExpenses(); currentTitle = 'Despesas'; break;
                case 'contatos': mainContent.innerHTML = renderContacts(); currentTitle = 'Contatos'; break;
                default: mainContent.innerHTML = renderWelcomeMessage();
            }
            mobileHeaderTitle.textContent = currentTitle;
            lucide.createIcons(); // Re-render icons after DOM update
        };

        const updateClientDropdown = () => {
            clientSelect.innerHTML = `<option value="">-- Visão Geral --</option>`;
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                if (client.id === selectedClientId) option.selected = true;
                clientSelect.appendChild(option);
            });
        };

        const updateNav = () => {
            const navItems = `
                <li><a href="#" data-module="dashboard" class="flex items-center gap-3 p-2 rounded-md transition ${activeModule === 'dashboard' ? 'bg-blue-100 text-blue-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'}"><i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard</a></li>
                ${selectedClientId ? `
                <li><a href="#" data-module="agenda" class="flex items-center gap-3 p-2 rounded-md transition ${activeModule === 'agenda' ? 'bg-blue-100 text-blue-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'}"><i data-lucide="calendar" class="w-5 h-5"></i> Agenda</a></li>
                <li><a href="#" data-module="tasks" class="flex items-center gap-3 p-2 rounded-md transition ${activeModule === 'tasks' ? 'bg-blue-100 text-blue-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'}"><i data-lucide="check-square" class="w-5 h-5"></i> Tarefas</a></li>
                <li><a href="#" data-module="travels" class="flex items-center gap-3 p-2 rounded-md transition ${activeModule === 'travels' ? 'bg-blue-100 text-blue-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'}"><i data-lucide="plane" class="w-5 h-5"></i> Viagens</a></li>
                <li><a href="#" data-module="expenses" class="flex items-center gap-3 p-2 rounded-md transition ${activeModule === 'expenses' ? 'bg-blue-100 text-blue-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'}"><i data-lucide="dollar-sign" class="w-5 h-5"></i> Despesas</a></li>
                <li><a href="#" data-module="contatos" class="flex items-center gap-3 p-2 rounded-md transition ${activeModule === 'contatos' ? 'bg-blue-100 text-blue-700 font-semibold' : 'text-gray-600 hover:bg-gray-100'}"><i data-lucide="contact" class="w-5 h-5"></i> Contatos</a></li>
                ` : ''}
            `;
            mainNav.innerHTML = `<ul class="space-y-2">${navItems}</ul>`;

            const mobileNavItems = `
                <a href="#" data-module="dashboard" class="flex flex-col items-center justify-center gap-1 p-1 rounded-md ${activeModule === 'dashboard' ? 'text-blue-600' : 'text-gray-500'}">
                    <i data-lucide="layout-dashboard" class="w-6 h-6"></i><span class="text-xs">Dashboard</span>
                </a>
                ${selectedClientId ? `
                <a href="#" data-module="agenda" class="flex flex-col items-center justify-center gap-1 p-1 rounded-md ${activeModule === 'agenda' ? 'text-blue-600' : 'text-gray-500'}">
                    <i data-lucide="calendar" class="w-6 h-6"></i><span class="text-xs">Agenda</span>
                </a>
                <a href="#" data-module="tasks" class="flex flex-col items-center justify-center gap-1 p-1 rounded-md ${activeModule === 'tasks' ? 'text-blue-600' : 'text-gray-500'}">
                    <i data-lucide="check-square" class="w-6 h-6"></i><span class="text-xs">Tarefas</span>
                </a>
                <a href="#" data-module="travels" class="flex flex-col items-center justify-center gap-1 p-1 rounded-md ${activeModule === 'travels' ? 'text-blue-600' : 'text-gray-500'}">
                    <i data-lucide="plane" class="w-6 h-6"></i><span class="text-xs">Viagens</span>
                </a>
                <a href="#" data-module="expenses" class="flex flex-col items-center justify-center gap-1 p-1 rounded-md ${activeModule === 'expenses' ? 'text-blue-600' : 'text-gray-500'}">
                    <i data-lucide="dollar-sign" class="w-6 h-6"></i><span class="text-xs">Despesas</span>
                </a>
                ` : ''}
            `;
            mobileNav.innerHTML = mobileNavItems;
        };

        const renderDashboard = () => {
            const todayStr = new Date().toISOString().split('T')[0];
            const forToday = [
                ...events.filter(e => e.date === todayStr).map(e => ({...e, type: 'event'})),
                ...tasks.filter(t => t.date === todayStr).map(t => ({...t, type: 'task'}))
            ].sort((a, b) => (a.time || '23:59').localeCompare(b.time || '23:59'));

            const pendingExpenses = expenses.filter(ex => ex.status !== 'Reembolsada');

            return `
                <h2 class="hidden md:block text-2xl md:text-3xl font-bold mb-6">Dashboard Consolidado</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold flex items-center gap-2"><i data-lucide="list-checks" class="text-blue-600"></i> Para Hoje</h3>
                            <button id="add-task-btn-dash" class="text-blue-600 hover:text-blue-800 p-1"><i data-lucide="plus-circle" class="w-6 h-6"></i></button>
                        </div>
                        <div class="space-y-3">
                        ${forToday.length > 0 ? forToday.map(item => `
                            <div class="p-3 bg-gray-50 rounded-md border border-gray-200 flex items-start gap-3">
                                <i data-lucide="${item.type === 'event' ? 'calendar' : 'check-square'}" class="w-5 h-5 text-gray-400 mt-1 flex-shrink-0"></i>
                                <div>
                                    <p class="font-semibold">${item.title || item.name}</p>
                                    <p class="text-sm text-gray-500">${getClientName(item.clientId)} ${item.time ? `- ${item.time}`: ''}</p>
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-500">Nenhuma pendência para hoje.</p>'}
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="receipt" class="text-green-600"></i> Despesas Pendentes</h3>
                        <div class="space-y-3">
                        ${pendingExpenses.length > 0 ? pendingExpenses.map(item => `
                           <div class="p-3 bg-gray-50 rounded-md border border-gray-200">
                                <p class="font-semibold">${item.description}</p>
                                <p class="text-sm text-gray-500">${getClientName(item.clientId)} - R$ ${item.amount.toFixed(2)}</p>
                            </div>
                        `).join('') : '<p class="text-gray-500">Nenhuma despesa pendente.</p>'}
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderTravels = () => {
             const clientTravels = travels.filter(t => t.clientId === selectedClientId).sort((a, b) => new Date(a.start) - new Date(b.start));
             const clientName = getClientName(selectedClientId);
             return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button id="add-travel-btn" class="flex items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition shadow-sm w-full sm:w-auto justify-center mb-6">
                        <i data-lucide="plus" class="w-5 h-5"></i> Nova Viagem
                    </button>
                    <ul class="space-y-4">
                        ${clientTravels.length > 0 ? clientTravels.map(travel => `
                            <li class="p-4 bg-gray-50 rounded-md border border-gray-200 flex justify-between items-start">
                               <div>
                                    <p class="font-bold text-lg">${travel.destination}</p>
                                    <p class="text-sm text-gray-600">${formatDate(travel.start)} a ${formatDate(travel.end)}</p>
                                    <p class="text-sm text-gray-500 mt-2 whitespace-pre-wrap">${travel.notes}</p>
                               </div>
                               <button class="btn-delete text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition" data-travel-id="${travel.id}">
                                   <i data-lucide="trash-2" class="w-5 h-5"></i>
                               </button>
                            </li>
                        `).join('') : '<p class="text-gray-500 text-center py-4">Nenhuma viagem cadastrada.</p>'}
                    </ul>
                </div>
             `;
        };

        const renderExpenses = () => {
             const clientExpenses = expenses.filter(e => e.clientId === selectedClientId).sort((a, b) => new Date(b.date) - new Date(a.date));
             const clientName = getClientName(selectedClientId);
             const statusColors = { Lançada: 'bg-yellow-100 text-yellow-800', Aprovada: 'bg-blue-100 text-blue-800', Reembolsada: 'bg-green-100 text-green-800' };
             return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button id="add-expense-btn" class="flex items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition shadow-sm w-full sm:w-auto justify-center mb-6">
                        <i data-lucide="plus" class="w-5 h-5"></i> Nova Despesa
                    </button>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b">
                                    <th class="p-2">Data</th>
                                    <th class="p-2">Descrição</th>
                                    <th class="p-2 text-right">Valor</th>
                                    <th class="p-2 text-center">Status</th>
                                    <th class="p-2"></th>
                                </tr>
                            </thead>
                            <tbody>
                            ${clientExpenses.length > 0 ? clientExpenses.map(expense => `
                                <tr class="border-b">
                                    <td class="p-2">${formatDate(expense.date)}</td>
                                    <td class="p-2">${expense.description}</td>
                                    <td class="p-2 text-right">R$ ${expense.amount.toFixed(2)}</td>
                                    <td class="p-2 text-center">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColors[expense.status]}">${expense.status}</span>
                                    </td>
                                    <td class="p-2 text-right">
                                        <button class="btn-delete text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition" data-expense-id="${expense.id}">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('') : '<tr><td colspan="5" class="text-center text-gray-500 py-4">Nenhuma despesa cadastrada.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
             `;
        };
        
        const renderAgenda = () => {
             const clientEvents = events.filter(e => e.clientId === selectedClientId).sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`));
             return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button id="add-event-btn" class="flex items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition shadow-sm w-full sm:w-auto justify-center mb-6">
                        <i data-lucide="calendar-plus" class="w-5 h-5"></i> Novo Evento
                    </button>
                    <ul class="space-y-4">
                        ${clientEvents.length > 0 ? clientEvents.map(event => `
                            <li class="p-4 bg-gray-50 rounded-md border border-gray-200 flex justify-between items-start">
                               <div>
                                    <p class="font-bold">${event.title}</p>
                                    <p class="text-sm text-gray-600">${formatDate(event.date)} às ${event.time}</p>
                                    <p class="text-sm text-gray-500 mt-1">${event.description}</p>
                               </div>
                               <button class="btn-delete text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition" data-event-id="${event.id}">
                                   <i data-lucide="trash-2" class="w-5 h-5"></i>
                               </button>
                            </li>
                        `).join('') : '<p class="text-gray-500 text-center py-4">Nenhum evento agendado.</p>'}
                    </ul>
                </div>
             `;
        };
        
        const renderTasks = () => {
             const clientTasks = tasks.filter(t => t.clientId === selectedClientId).sort((a, b) => new Date(a.date) - new Date(b.date));
             return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <button id="add-task-btn" class="flex items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition shadow-sm w-full sm:w-auto justify-center mb-6">
                        <i data-lucide="plus" class="w-5 h-5"></i> Nova Tarefa
                    </button>
                    <ul class="space-y-4">
                        ${clientTasks.length > 0 ? clientTasks.map(task => `
                            <li class="p-4 bg-gray-50 rounded-md border border-gray-200 flex justify-between items-start">
                               <div>
                                    <p class="font-bold">${task.title}</p>
                                    <p class="text-sm text-gray-600">Data: ${formatDate(task.date)}</p>
                               </div>
                               <button class="btn-delete text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition" data-task-id="${task.id}">
                                   <i data-lucide="trash-2" class="w-5 h-5"></i>
                               </button>
                            </li>
                        `).join('') : '<p class="text-gray-500 text-center py-4">Nenhuma tarefa cadastrada.</p>'}
                    </ul>
                </div>
             `;
        };

        const renderContacts = () => {
            const clientContacts = contacts.filter(c => c.clientId === selectedClientId).sort((a, b) => a.name.localeCompare(b.name));
            return `
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <button id="add-contact-btn" class="flex items-center gap-2 bg-blue-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-700 transition shadow-sm w-full sm:w-auto justify-center mb-6">
                        <i data-lucide="user-plus" class="w-5 h-5"></i> Novo Contato
                    </button>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${clientContacts.length > 0 ? clientContacts.map(contact => `
                            <div class="p-4 border border-gray-200 rounded-lg bg-gray-50 relative">
                                <button class="btn-delete absolute top-2 right-2 text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100 transition" data-contact-id="${contact.id}">
                                   <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                                <p class="font-bold text-lg">${contact.name}</p>
                                <p class="text-sm text-gray-600">${contact.company || ''}</p>
                                <div class="mt-3 text-sm space-y-1">
                                    <p class="flex items-center gap-2"><i data-lucide="mail" class="w-4 h-4 text-gray-400"></i> ${contact.email || 'N/A'}</p>
                                    <p class="flex items-center gap-2"><i data-lucide="phone" class="w-4 h-4 text-gray-400"></i> ${contact.phone || 'N/A'}</p>
                                    <p class="flex items-center gap-2"><i data-lucide="cake" class="w-4 h-4 text-gray-400"></i> ${formatDate(contact.birthday)}</p>
                                    <p class="text-xs text-gray-500 mt-2 pt-2 border-t">${contact.notes || ''}</p>
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-center py-4 col-span-full">Nenhum contato cadastrado.</p>'}
                    </div>
                </div>
            `;
        };
        
        const renderWelcomeMessage = () => `...`; // Unchanged

        // --- HELPER FUNCTIONS ---
        const getClientName = (clientId) => clients.find(c => c.id === clientId)?.name || 'Desconhecido';
        const formatDate = (dateString, includeYear = false) => {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const userTimezoneOffset = date.getTimezoneOffset() * 60000;
            const localDate = new Date(date.getTime() + userTimezoneOffset);
            const options = { day: '2-digit', month: '2-digit' };
            if (includeYear) options.year = 'numeric';
            return localDate.toLocaleDateString('pt-BR', options);
        };

        // --- EVENT HANDLERS ---
        const handleNavClick = (module) => { activeModule = module; closeSidebar(); render(); };
        clientSelect.addEventListener('change', (e) => {
            const val = e.target.value;
            selectedClientId = val ? parseInt(val, 10) : null;
            activeModule = selectedClientId ? 'agenda' : 'dashboard';
            saveState(); render();
        });
        mainNav.addEventListener('click', (e) => { e.preventDefault(); const link = e.target.closest('a'); if (link && link.dataset.module) handleNavClick(link.dataset.module); });
        mobileNav.addEventListener('click', (e) => { e.preventDefault(); const link = e.target.closest('a'); if (link && link.dataset.module) handleNavClick(link.dataset.module); });
        const openSidebar = () => { sidebar.classList.remove('-translate-x-full'); sidebarOverlay.classList.remove('hidden'); };
        const closeSidebar = () => { sidebar.classList.add('-translate-x-full'); sidebarOverlay.classList.add('hidden'); };
        hamburgerBtn.addEventListener('click', openSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        const openModal = (modal) => {
            if (modal === addTaskModal) {
                const clientSelector = document.getElementById('new-task-client');
                clientSelector.innerHTML = '';
                clients.forEach(c => { const option = document.createElement('option'); option.value = c.id; option.textContent = c.name; clientSelector.appendChild(option); });
            }
            modal.classList.remove('hidden');
        }
        const closeModal = (modal) => { modal.classList.add('hidden'); modal.querySelector('form')?.reset(); };
        document.getElementById('add-client-btn').addEventListener('click', () => openModal(addClientModal));
        mainContent.addEventListener('click', (e) => {
            if (e.target.closest('#add-event-btn')) openModal(addEventModal);
            if (e.target.closest('#add-contact-btn')) openModal(addContactModal);
            if (e.target.closest('#add-task-btn') || e.target.closest('#add-task-btn-dash')) openModal(addTaskModal);
            if (e.target.closest('#add-travel-btn')) openModal(addTravelModal);
            if (e.target.closest('#add-expense-btn')) openModal(addExpenseModal);
            
            const deleteBtn = e.target.closest('.btn-delete');
            if (deleteBtn) {
                const { eventId, contactId, taskId, travelId, expenseId } = deleteBtn.dataset;
                if (eventId && confirm('Tem certeza?')) { events = events.filter(i => i.id !== parseInt(eventId)); saveState(); render(); }
                if (contactId && confirm('Tem certeza?')) { contacts = contacts.filter(i => i.id !== parseInt(contactId)); saveState(); render(); }
                if (taskId && confirm('Tem certeza?')) { tasks = tasks.filter(i => i.id !== parseInt(taskId)); saveState(); render(); }
                if (travelId && confirm('Tem certeza?')) { travels = travels.filter(i => i.id !== parseInt(travelId)); saveState(); render(); }
                if (expenseId && confirm('Tem certeza?')) { expenses = expenses.filter(i => i.id !== parseInt(expenseId)); saveState(); render(); }
            }
        });
        document.querySelectorAll('[data-close-modal]').forEach(btn => btn.addEventListener('click', () => closeModal(btn.closest('.modal-backdrop'))));

        // Form Submissions
        addClientForm.addEventListener('submit', (e) => { e.preventDefault(); const name = document.getElementById('new-client-name').value; if (name.trim()) { clients.push({ id: Date.now(), name: name.trim() }); saveState(); render(); closeModal(addClientModal); } });
        addEventForm.addEventListener('submit', (e) => { e.preventDefault(); events.push({ id: Date.now(), clientId: selectedClientId, title: document.getElementById('new-event-title').value, date: document.getElementById('new-event-date').value, time: document.getElementById('new-event-time').value, description: document.getElementById('new-event-description').value }); saveState(); render(); closeModal(addEventModal); });
        addTaskForm.addEventListener('submit', (e) => { e.preventDefault(); tasks.push({ id: Date.now(), clientId: parseInt(document.getElementById('new-task-client').value), title: document.getElementById('new-task-title').value, date: document.getElementById('new-task-date').value }); saveState(); render(); closeModal(addTaskModal); });
        addContactForm.addEventListener('submit', (e) => { e.preventDefault(); contacts.push({ id: Date.now(), clientId: selectedClientId, name: document.getElementById('new-contact-name').value, company: document.getElementById('new-contact-company').value, email: document.getElementById('new-contact-email').value, phone: document.getElementById('new-contact-phone').value, birthday: document.getElementById('new-contact-birthday').value, notes: document.getElementById('new-contact-notes').value }); saveState(); render(); closeModal(addContactModal); });
        addTravelForm.addEventListener('submit', (e) => { e.preventDefault(); travels.push({ id: Date.now(), clientId: selectedClientId, destination: document.getElementById('new-travel-destination').value, start: document.getElementById('new-travel-start').value, end: document.getElementById('new-travel-end').value, notes: document.getElementById('new-travel-notes').value }); saveState(); render(); closeModal(addTravelModal); });
        addExpenseForm.addEventListener('submit', (e) => { e.preventDefault(); expenses.push({ id: Date.now(), clientId: selectedClientId, date: document.getElementById('new-expense-date').value, description: document.getElementById('new-expense-description').value, amount: parseFloat(document.getElementById('new-expense-amount').value), status: document.getElementById('new-expense-status').value }); saveState(); render(); closeModal(addExpenseModal); });

        // --- INITIALIZATION ---
        loadState();
        render();
    });
    </script>
</body>
</html>
